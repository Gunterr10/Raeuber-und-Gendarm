<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ========= SUPABASE =========
const SUPABASE_URL = "https://vvqrtridwsnogpvuszup.supabase.co";
const SUPABASE_KEY = "sb_publishable_ahah-w8vjtxQ3d3KeOATFg_NsXzsljk";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

// ========= STATE =========
const ADMIN_PASS = "1234";
let timerInterval = null;

let game = {
  role:null,
  user:null,
  players:[]
};

// ========= LOGIN =========
function showLogin(){
  popup.style.display="flex";
  popup.firstElementChild.innerHTML=`
    <h3>Login</h3>
    <label class="label">Rolle</label>
    <select id="loginRole" onchange="updateLoginFields()">
      <option value="admin">Admin</option>
      <option value="polizist">Polizist</option>
    </select>
    <div id="loginFields"></div>
    <button class="success" onclick="login()">Einloggen</button>
  `;
  updateLoginFields();
}

function updateLoginFields(){
  if(loginRole.value==="admin"){
    loginFields.innerHTML=`
      <label class="label">Admin Passwort</label>
      <input id="loginPass" type="password">
    `;
  } else {
    loginFields.innerHTML=`
      <label class="label">Name</label>
      <input id="loginName">
      <label class="label">Passwort</label>
      <input id="loginPass" type="password">
    `;
  }
}

async function login(){
  if(loginRole.value==="admin"){
    if(loginPass.value!==ADMIN_PASS){
      alert("Falsches Passwort"); return;
    }
    game.role="admin";
    game.user="Admin";
  } else {
    const { data } = await supabase
      .from("players")
      .select("*")
      .eq("role","polizist")
      .eq("name",loginName.value)
      .eq("password",loginPass.value)
      .single();

    if(!data){
      alert("Name oder Passwort falsch"); return;
    }
    game.role="polizist";
    game.user=data.name;
  }

  popup.style.display="none";
  loginBtn.style.display="none";
  logoutBtn.style.display="inline-block";
  render();
}

function logout(){
  game.role=null;
  game.user=null;
  loginBtn.style.display="inline-block";
  logoutBtn.style.display="none";
  render();
}

// ========= ADMIN =========
function showAdmin(){
  adminPanel.style.display="block";
  adminPanel.innerHTML=`
    <h3>Admin</h3>

    <label class="label">Name</label>
    <input id="playerName">

    <label class="label">Passwort (nur Polizist)</label>
    <input id="playerPass">

    <label class="label">Rolle</label>
    <select id="playerRole">
      <option value="raeuber">Räuber</option>
      <option value="polizist">Polizist</option>
    </select>

    <button class="success" onclick="addPlayer()">Spieler hinzufügen</button>
    <button class="primary" onclick="startTimer()">⏱️ TIMER STARTEN (10:00)</button>
    <button class="danger" onclick="resetGame()">Spiel zurücksetzen</button>
  `;
}

async function addPlayer(){
  const name = playerName.value.trim();
  if(!name){ alert("Name fehlt"); return; }

  await supabase.from("players").insert({
    name: name,
    password: playerPass.value,
    role: playerRole.value,
    caught: false
  });
}

async function resetGame(){
  if(!confirm("Spiel wirklich zurücksetzen?")) return;
  await supabase.from("players").delete().neq("id","000");
  await supabase.from("game_state")
    .update({ running:false, timer_start:null })
    .eq("id",1);
}

// ========= TIMER (SYNC) =========
async function startTimer(){
  await supabase
    .from("game_state")
    .update({
      timer_start: new Date().toISOString(),
      running: true
    })
    .eq("id",1);
}

async function loadTimer(){
  const { data } = await supabase
    .from("game_state")
    .select("*")
    .eq("id",1)
    .single();

  if(!data || !data.running) return;

  const start = new Date(data.timer_start).getTime();
  const duration = 10 * 60 * 1000;

  timerBar.style.display="block";
  clearInterval(timerInterval);

  timerInterval = setInterval(()=>{
    const left = duration - (Date.now() - start);
    if(left <= 0){
      timer.textContent="00:00";
      clearInterval(timerInterval);
      return;
    }
    updateTimer(Math.floor(left/1000));
  },1000);
}

function updateTimer(seconds){
  const m = String(Math.floor(seconds/60)).padStart(2,"0");
  const s = String(seconds%60).padStart(2,"0");
  timer.textContent=`${m}:${s}`;
}

// ========= POLIZEI =========
function showPolice(){
  policePanel.style.display="block";
  policePanel.innerHTML=`<h3>Polizist: ${game.user}</h3>`;
}

// ========= SPIELER =========
async function loadPlayers(){
  const { data } = await supabase
    .from("players")
    .select("*")
    .order("name");

  game.players = data || [];
  render();
}

function render(){
  players.innerHTML="";
  game.players.forEach(p=>{
    players.innerHTML+=`
      <div class="player-card ${p.role}">
        <h4>${p.name}</h4>

        <div class="label">Team</div>
        <div class="value">${p.role}</div>

        <div class="label">Status</div>
        ${
          p.role==="raeuber" && game.role==="polizist"
          ? `<button class="primary" onclick="toggle('${p.id}',${p.caught})">
              ${p.caught?"Freilassen":"Fangen"}
            </button>`
          : `<span class="badge ${p.caught?"red":"green"}">
              ${p.caught?"Gefangen":"Frei"}
            </span>`
        }
      </div>
    `;
  });

  adminPanel.style.display="none";
  policePanel.style.display="none";
  if(game.role==="admin") showAdmin();
  if(game.role==="polizist") showPolice();
}

async function toggle(id,caught){
  await supabase
    .from("players")
    .update({ caught: !caught })
    .eq("id",id);
}

// ========= REALTIME =========
supabase
  .channel("live")
  .on("postgres_changes",{event:"*",schema:"public",table:"players"},loadPlayers)
  .on("postgres_changes",{event:"*",schema:"public",table:"game_state"},loadTimer)
  .subscribe();

// ========= START =========
loadPlayers();
loadTimer();
</script>
